<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekapan Gaji</title>
    <link rel="stylesheet" href="style.css?v=9999">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    
    <style>
        /* GAYA TABEL KHUSUS AGAR MUAT BANYAK DI HP */
        .container { padding: 10px; padding-bottom: 100px; }
        table { border-collapse: collapse; width: 100%; font-size: 11px; font-family: sans-serif; }
        th, td { border: 1px solid #ccc; padding: 5px 4px; white-space: nowrap; height: 35px; vertical-align: middle; }
        
        /* HEADER MERAH STICKY */
        thead th { background-color: #800000; color: white; position: sticky; top: 0; z-index: 20; font-size: 10px; text-transform: uppercase; }

        /* --- STICKY COLUMN (KUNCI KOLOM KIRI) --- */
        /* 1. NO */
        th:nth-child(1), td:nth-child(1) {
            position: sticky; left: 0; z-index: 25; background-color: #fff; width: 25px; min-width: 25px; text-align: center; border-right: 1px solid #eee;
        }
        /* 2. NAMA */
        th:nth-child(2), td:nth-child(2) {
            position: sticky; left: 25px; z-index: 25; background-color: #fff; width: 90px; min-width: 90px; max-width: 90px; overflow: hidden; text-overflow: ellipsis; border-right: 2px solid #800000; font-weight: bold; color: #333;
        }
        
        /* Header Sticky */
        thead th:nth-child(1) { background-color: #800000; z-index: 30; }
        thead th:nth-child(2) { background-color: #800000; z-index: 30; border-right: 2px solid white; }

        /* Footer Sticky */
        tfoot td { position: sticky; bottom: 0; background: #eee; font-weight: bold; z-index: 15; font-size: 10px; }
        tfoot td:nth-child(1) { position: sticky; left: 0; z-index: 30; border-right: none; }
        
        /* Belang-belang */
        tbody tr:nth-child(even) td { background-color: #f9f9f9; }
        tbody tr:nth-child(odd) td:nth-child(1), tbody tr:nth-child(odd) td:nth-child(2) { background-color: #fff; }
        tbody tr:nth-child(even) td:nth-child(1), tbody tr:nth-child(even) td:nth-child(2) { background-color: #f9f9f9; }
    </style>
</head>
<body id="page-rekapan-gaji">
    <div class="navbar no-print">
        <a href="dashboard.html" class="nav-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="brand-text">
            <h2>Rekapan</h2>
            <p>Laporan Keuangan</p>
        </div>
        <i class="fas fa-file-excel nav-btn" onclick="exportExcel()" title="Unduh" style="cursor: pointer; margin-left: auto;"></i>
    </div>

    <div class="container">
        <div class="card" style="padding:0; overflow-x: auto; max-height: 65vh; margin-bottom: 10px;">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Nama</th>
                        <th>Ulos</th>
                        <th>Pakan</th>
                        <th>Pot. Lain</th>
                        <th>Bersih</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tbodyGaji" style="text-align:center;">
                    <tr><td colspan="7" style="padding:20px;">Memuat data...</td></tr>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="2" style="text-align:right; border-right: 2px solid #800000;">TOTAL:</td>
                        <td><span id="t_ulos">0</span></td>
                        <td style="color:red;" id="t_pakan">0</td>
                        <td>-</td>
                        <td style="color:green;" id="t_gaji">0</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <div class="card" style="background:#fff3e0; border:1px solid #ffcc80; padding: 15px;">
            <h4 style="margin:0 0 10px 0; color:#e65100; font-size:0.9rem;">Ringkasan Periode Ini</h4>
            <div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px dashed #ccc; padding-bottom:5px; margin-bottom:5px;">
                <span>Total Ulos:</span><strong id="info_ulos">0</strong>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:0.85rem; border-bottom:1px dashed #ccc; padding-bottom:5px; margin-bottom:5px;">
                <span>Total Pakan:</span><strong id="info_pakan" style="color:red;">0</strong>
            </div>
            <div style="display:flex; justify-content:space-between; font-size:1rem;">
                <span>Total Gaji:</span><strong id="info_gaji" style="color:green;">0</strong>
            </div>
        </div>
    </div>

    <div class="bottom-nav no-print" style="position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #ffffff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 99999; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);">
        <a href="dashboard.html" class="nav-item" style="text-decoration:none;color:#999;text-align:center;font-size:0.75rem;display:flex;flex-direction:column;align-items:center;"><i class="fas fa-home" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Home</span></a>
        <a href="pesanan.html" class="nav-item" style="text-decoration:none;color:#999;text-align:center;font-size:0.75rem;display:flex;flex-direction:column;align-items:center;"><i class="fas fa-clipboard-list" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Pesanan</span></a>
        <a href="data_karyawan.html" class="nav-item" style="text-decoration:none;color:#999;text-align:center;font-size:0.75rem;display:flex;flex-direction:column;align-items:center;"><i class="fas fa-users" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Karyawan</span></a>
        <a href="slip_gaji.html" class="nav-item active" style="text-decoration:none;color:#800000;font-weight:bold;text-align:center;font-size:0.75rem;display:flex;flex-direction:column;align-items:center;"><i class="fas fa-wallet" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Keuangan</span></a>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const formatRupiah = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);
        
        // Pembersih Angka (PENTING AGAR TIDAK ERROR/0)
        const parseNumber = (val) => {
            if (!val) return 0;
            if (typeof val === 'number') return val;
            const cleanStr = String(val).replace(/[^0-9.-]+/g, ""); 
            return Number(cleanStr) || 0;
        };

        async function loadRekapan() {
            const tbody = document.getElementById('tbodyGaji');
            try {
                const q = query(collection(db, "gaji"), orderBy("timestamp", "desc"));
                const snap = await getDocs(q);

                tbody.innerHTML = '';

                if (snap.empty) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding:20px;">Belum ada data gaji.</td></tr>';
                    return;
                }

                let totalGaji = 0;
                let totalPakan = 0;
                let totalUlos = 0;
                let no = 1;

                snap.forEach(doc => {
                    const d = doc.data();
                    
                    // Ambil angka dengan aman
                    const pakan = parseNumber(d.pakan);
                    const jumlah = parseNumber(d.jumlah);
                    const gaji = parseNumber(d.gajiBersih);
                    const potLain = parseNumber(d.pot_air) + parseNumber(d.pot_wifi) + parseNumber(d.pot_stell) + parseNumber(d.pot_lain);

                    totalGaji += gaji;
                    totalPakan += pakan;
                    totalUlos += jumlah;

                    const row = `
                    <tr>
                        <td>${no++}</td>
                        <td style="text-align:left;">${d.nama_karyawan}</td>
                        <td>${d.nama_ulos}<br><small style="background:#eee; padding:1px 4px; border-radius:4px;">${jumlah} Lbr</small></td>
                        <td style="color:red;">${formatRupiah(pakan)}</td>
                        <td>${formatRupiah(potLain)}</td>
                        <td style="font-weight:bold; color:green;">${formatRupiah(gaji)}</td>
                        <td>
                            <button onclick="hapusData('${doc.id}')" style="background:#dc3545; color:white; border:none; border-radius:4px; width:25px; height:25px; cursor:pointer;">
                                <i class="fas fa-trash" style="font-size:0.7rem;"></i>
                            </button>
                        </td>
                    </tr>`;
                    
                    tbody.innerHTML += row;
                });

                // Update Total di Tabel
                document.getElementById('t_ulos').innerText = totalUlos;
                document.getElementById('t_pakan').innerText = formatRupiah(totalPakan);
                document.getElementById('t_gaji').innerText = formatRupiah(totalGaji);

                // Update Total di Ringkasan Bawah
                document.getElementById('info_ulos').innerText = totalUlos + " Lembar";
                document.getElementById('info_pakan').innerText = formatRupiah(totalPakan);
                document.getElementById('info_gaji').innerText = formatRupiah(totalGaji);

            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="7" style="color:red;">Gagal: ${error.message}</td></tr>`;
            }
        }

        window.hapusData = async (id) => {
            if (confirm("Hapus data gaji ini permanen?")) {
                await deleteDoc(doc(db, "gaji", id));
                loadRekapan();
            }
        };

        window.exportExcel = () => {
            const t = document.querySelector("table");
            const w = XLSX.utils.table_to_book(t);
            XLSX.writeFile(w, "Rekapan_Gaji_Borsin.xlsx");
        };

        loadRekapan();
    </script>
</body>
</html>
