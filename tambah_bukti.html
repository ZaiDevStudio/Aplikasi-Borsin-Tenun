<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Bukti Transfer</title>
    <link rel="stylesheet" href="style.css?v=9999">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>.container { padding-bottom: 100px; }</style>
</head>
<body id="page-tambah-bukti">
    
    <div class="navbar">
        <a href="dashboard.html" class="nav-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="brand-text">
            <h2>Upload Bukti</h2>
            <p>Konfirmasi Pembayaran</p>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <form id="formBukti">
                <div class="form-group">
                    <label>Pilih Karyawan</label>
                    <select id="nama_karyawan" class="form-control" required>
                        <option value="">-- Sedang menghubungkan... --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Foto Bukti Transfer</label>
                    <div style="background:#f9f9f9; padding:15px; border-radius:10px; text-align:center; border:2px dashed #800000;">
                        <input type="file" id="foto" accept="image/*" required style="display:block; width:100%;">
                        <small style="color:#888;">Klik untuk pilih foto</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>Keterangan (Opsional)</label>
                    <input type="text" id="keterangan" class="form-control" placeholder="Contoh: Gaji November">
                </div>

                <button type="submit" id="btnSimpan" class="btn btn-success" style="margin-top:15px;">Simpan & Upload</button>
            </form>
        </div>
    </div>

    <div class="bottom-nav" style="position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #ffffff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 99999; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);">
        <a href="dashboard.html" class="nav-item"><i class="fas fa-home" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Home</span></a>
        <a href="bukti_pembayaran.html" class="nav-item"><i class="fas fa-receipt" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Bukti pembayaran</span></a>
        <a href="data_karyawan.html" class="nav-item"><i class="fas fa-users" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Karyawan</span></a>
        <a href="slip_gaji.html" class="nav-item active" style="color:#800000;font-weight:bold;"><i class="fas fa-wallet" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Keuangan</span></a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIG SESUAI PUNYA BAPAK
        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const max = 600; const scale = max / img.width; canvas.width = max; canvas.height = img.height * scale; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; };
        });

        // FUNGSI LOAD DATA DENGAN LAPORAN ERROR
        async function loadData() {
            const select = document.getElementById('nama_karyawan');
            
            try {
                // Coba Ambil Data
                const q = query(collection(db, "karyawan"), orderBy("nama"));
                const snap = await getDocs(q);
                
                // Reset Dropdown
                select.innerHTML = '<option value="">-- Pilih Karyawan --</option>';
                
                // Cek Apakah Kosong
                if (snap.empty) {
                    alert("PERINGATAN: Database Karyawan Kosong! Silakan input data karyawan terlebih dahulu.");
                    select.innerHTML = '<option value="">Data Kosong</option>';
                    return;
                }

                // Isi Dropdown
                snap.forEach(doc => {
                    const d = doc.data();
                    const opt = document.createElement('option');
                    opt.value = d.nama;
                    opt.text = d.nama;
                    select.appendChild(opt);
                });

            } catch (error) {
                // JIKA ERROR, TAMPILKAN PESANNYA
                alert("GAGAL MEMUAT DATA:\n" + error.message + "\n\nCek koneksi internet Anda!");
                select.innerHTML = '<option value="">-- Gagal --</option>';
            }
        }

        // LOGIKA SIMPAN
        document.getElementById('formBukti').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            btn.innerText = "Mengupload..."; btn.disabled = true;

            try {
                const nama = document.getElementById('nama_karyawan').value;
                if(!nama) throw new Error("Pilih Karyawan dulu!");

                const fileInput = document.getElementById('foto');
                const fotoBase64 = await resizeImage(fileInput.files[0]);

                await addDoc(collection(db, "bukti_gaji"), {
                    nama_karyawan: nama,
                    foto: fotoBase64,
                    keterangan: document.getElementById('keterangan').value,
                    timestamp: new Date()
                });

                alert("Bukti Berhasil Diupload!");
                window.location.href = "bukti_pembayaran.html";

            } catch (error) {
                alert("Gagal: " + error.message);
                btn.innerText = "Simpan & Upload"; btn.disabled = false;
            }
        });

        // Jalankan saat halaman dibuka
        loadData();
    </script>
</body>
</html>
