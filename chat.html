<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diskusi Tim</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        * { box-sizing: border-box; font-family: 'Poppins', sans-serif; margin: 0; padding: 0; }

        body { background-color: #E5DDD5; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER */
        .navbar {
            background: linear-gradient(135deg, #800000 0%, #580000 100%);
            color: white; padding: 15px 20px; display: flex; align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
        }
        .nav-btn { color: white; font-size: 1.2rem; margin-right: 15px; cursor: pointer; text-decoration: none; }
        .brand-text h2 { font-size: 1.1rem; margin: 0; font-weight: 600; }
        .brand-text p { font-size: 0.75rem; margin: 0; opacity: 0.8; }
        
        /* TOMBOL HAPUS SEMUA (POJOK KANAN) */
        #btnDelAll { margin-left: auto; color: #ffcccc; font-size: 1.2rem; cursor: pointer; display: none; }

        /* CONTAINER CHAT */
        #chatContainer {
            flex: 1; overflow-y: auto; padding: 15px;
            display: flex; flex-direction: column; gap: 8px;
            padding-bottom: 140px; 
            background-image: url("https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png");
            background-color: #e5ddd5;
        }

        /* BUBBLE PESAN */
        .msg {
            max-width: 80%; padding: 8px 10px; border-radius: 10px;
            font-size: 0.9rem; position: relative; word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1); line-height: 1.4; display: flex; flex-direction: column;
        }
        .msg-left { align-self: flex-start; background: white; border-top-left-radius: 0; }
        .msg-right { align-self: flex-end; background: #dcf8c6; border-top-right-radius: 0; }

        /* NAMA & LABEL */
        .sender-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .sender-name { font-size: 0.75rem; color: #d32f2f; font-weight: bold; }
        .badge-admin { background: #FFD700; color: #800000; font-size: 0.6rem; padding: 1px 4px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        
        /* KONTEN */
        .msg-text { margin-bottom: 2px; }
        .msg-meta { align-self: flex-end; display: flex; align-items: center; gap: 4px; margin-top: 2px; }
        .msg-time { font-size: 0.65rem; color: #999; }
        .msg-check { font-size: 0.7rem; color: #34B7F1; } 

        /* HAPUS PESAN (TONG SAMPAH KECIL) */
        .delete-msg { font-size: 0.7rem; color: #aaa; cursor: pointer; margin-left: 8px; }
        .delete-msg:hover { color: red; }

        /* REPLY STYLE */
        .reply-content { background: rgba(0,0,0,0.05); border-left: 4px solid #800000; padding: 5px; border-radius: 5px; margin-bottom: 5px; font-size: 0.8rem; display: flex; flex-direction: column; cursor: pointer; }
        .reply-name { font-weight: bold; color: #800000; font-size: 0.7rem; }
        .reply-text { color: #555; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* GAMBAR */
        .chat-img { width: 100%; max-width: 250px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; border: 1px solid #ddd; }

        /* INPUT AREA */
        .input-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; background: #f0f0f0; z-index: 999; box-shadow: 0 -2px 5px rgba(0,0,0,0.1); }
        #previewPanel { display: none; padding: 10px; background: #e9e9e9; border-bottom: 1px solid #ccc; justify-content: space-between; align-items: center; }
        .preview-content { flex: 1; font-size: 0.85rem; color: #333; border-left: 4px solid #800000; padding-left: 8px; }
        .close-preview { font-size: 1.2rem; color: #555; padding: 5px; cursor: pointer; }
        .input-area { padding: 8px 10px; display: flex; align-items: center; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 15px; border-radius: 25px; border: none; outline: none; font-size: 0.95rem; background: white; max-height: 100px; }
        .btn-icon { width: 40px; height: 40px; border-radius: 50%; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1.1rem; color: #555; background: transparent; }
        .btn-send { background: #800000; color: white; }
        .btn-reply-msg { font-size: 0.8rem; color: #aaa; cursor: pointer; margin-left: 5px; }
        
        #imgModal { display:none; position:fixed; z-index:10002; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; }
    </style>
</head>
<body>
    
    <div class="navbar">
        <a href="dashboard.html" class="nav-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="brand-text"><h2>Diskusi Tim</h2><p>Borsin Tenun</p></div>
        <i class="fas fa-trash-alt" id="btnDelAll" title="Hapus Semua"></i>
    </div>

    <div id="chatContainer"><p style="text-align:center;margin-top:20px;">Menghubungkan...</p></div>

    <div class="input-wrapper">
        <div id="previewPanel"><div class="preview-content" id="previewText">Membalas...</div><i class="fas fa-times close-preview" onclick="cancelAttachment()"></i></div>
        <form class="input-area" id="chatForm">
            <input type="file" id="fileInput" accept="image/*" style="display: none;">
            <button type="button" class="btn-icon" onclick="document.getElementById('fileInput').click()"><i class="fas fa-camera"></i></button>
            <input type="text" id="msgInput" class="chat-input" placeholder="Ketik pesan..." autocomplete="off">
            <button type="submit" class="btn-icon btn-send"><i class="fas fa-paper-plane"></i></button>
        </form>
    </div>

    <div id="imgModal" onclick="this.style.display='none'"><img id="imgModalContent" style="max-width:95%;max-height:95%;border:2px solid white;border-radius:5px;"></div>

    <script type="module">
        // IMPORT YANG BENAR & LENGKAP
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, getDoc, writeBatch, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let currentUser = null;
        let currentName = "User";
        let currentRole = "user";
        let replyTo = null; 
        let imageToSend = null;

        const resizeImage = (file) => new Promise((resolve) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const canvas = document.createElement('canvas'); const max = 600; const scale = max / img.width; canvas.width = max; canvas.height = img.height * scale; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, canvas.width, canvas.height); resolve(canvas.toDataURL('image/jpeg', 0.7)); }; };
        });

        window.viewImage = (src) => { document.getElementById('imgModal').style.display="flex"; document.getElementById('imgModalContent').src=src; };
        window.cancelAttachment = () => { replyTo = null; imageToSend = null; document.getElementById('previewPanel').style.display = 'none'; document.getElementById('fileInput').value = ''; };
        window.setReply = (nama, text) => { replyTo = { nama, text }; imageToSend = null; document.getElementById('previewPanel').style.display = 'flex'; document.getElementById('previewText').innerHTML = `<strong>Membalas ${nama}:</strong><br>${text.substring(0, 30)}...`; document.getElementById('msgInput').focus(); };
        
        // FUNGSI HAPUS PESAN SATUAN
        window.deleteMsg = async (id) => {
            if(confirm("Hapus pesan ini?")) {
                try {
                    await deleteDoc(doc(db, "chats", id));
                } catch(e) { alert("Gagal hapus: " + e.message); }
            }
        };

        document.getElementById('fileInput').addEventListener('change', async (e) => {
            if (e.target.files[0]) {
                imageToSend = await resizeImage(e.target.files[0]);
                replyTo = null; 
                document.getElementById('previewPanel').style.display = 'flex'; 
                document.getElementById('previewText').innerHTML = `<strong>ðŸ“· Gambar Siap Dikirim</strong>`; 
            }
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                localStorage.setItem('lastChatRead', new Date().toISOString());
                try {
                    const docSnap = await getDoc(doc(db, "users", user.uid));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        currentName = data.nama || user.email.split('@')[0];
                        currentRole = data.role || "user";
                        if (currentRole === 'admin') document.getElementById('btnDelAll').style.display = 'block';
                    }
                } catch (e) {}
                initChat();
            } else window.location.href = 'login.html';
        });

        function initChat() {
            const q = query(collection(db, "chats"), orderBy("timestamp", "asc"));
            onSnapshot(q, (snapshot) => {
                const container = document.getElementById('chatContainer');
                container.innerHTML = ''; 
                if(snapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#888;margin-top:20px;">Mulai percakapan baru.</p>'; return; }
                
                snapshot.forEach((doc) => {
                    const msg = doc.data();
                    const isMe = msg.uid === currentUser.uid;
                    const time = msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '..';
                    
                    const div = document.createElement('div');
                    div.className = isMe ? 'msg msg-right' : 'msg msg-left';
                    
                    // Header Pengirim
                    let senderHeader = '';
                    if (!isMe) {
                        const badge = msg.role === 'admin' ? '<span class="badge-admin">ADMIN</span>' : '';
                        senderHeader = `<div class="sender-header"><span class="sender-name">${msg.nama} ${badge}</span></div>`;
                    }

                    // Reply Box
                    let replyBox = '';
                    if (msg.replyTo) {
                        replyBox = `<div class="reply-content"><span class="reply-name">${msg.replyTo.nama}</span><span class="reply-text">${msg.replyTo.text}</span></div>`;
                    }

                    // Gambar
                    let imgBox = '';
                    if (msg.image) {
                        imgBox = `<img src="${msg.image}" class="chat-img" onclick="viewImage('${msg.image}')">`;
                    }

                    // Ikon-ikon (Reply, Delete, Check)
                    const replyIcon = `<i class="fas fa-reply btn-reply-msg" onclick="setReply('${msg.nama}', '${msg.text || "[Gambar]"}')"></i>`;
                    const checks = isMe ? `<i class="fas fa-check-double msg-check"></i>` : '';
                    
                    // Tombol Hapus (Muncul jika itu pesan saya ATAU saya admin)
                    let deleteIcon = '';
                    if (isMe || currentRole === 'admin') {
                        deleteIcon = `<i class="fas fa-trash-alt delete-msg" onclick="deleteMsg('${doc.id}')"></i>`;
                    }

                    div.innerHTML = `
                        ${senderHeader}
                        ${replyBox}
                        ${imgBox}
                        <span class="msg-text">${msg.text}</span>
                        <div class="msg-meta">
                            <span class="msg-time">${time}</span>
                            ${deleteIcon}
                            ${replyIcon}
                            ${checks}
                        </div>
                    `;
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
                localStorage.setItem('lastChatRead', new Date().toISOString());
            });
        }

        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const input = document.getElementById('msgInput');
            const text = input.value.trim();
            
            if ((text || imageToSend) && currentUser) {
                const payload = {
                    text: text,
                    image: imageToSend || '',
                    replyTo: replyTo ? { nama: replyTo.nama, text: replyTo.text } : null,
                    uid: currentUser.uid,
                    nama: currentName,
                    role: currentRole,
                    timestamp: new Date()
                };
                input.value = ''; window.cancelAttachment();
                await addDoc(collection(db, "chats"), payload);
            }
        });

        // HAPUS SEMUA (Batch Delete Fix)
        document.getElementById('btnDelAll').onclick = async () => {
            if(confirm("Hapus SEMUA chat?")) {
                try {
                    const q = query(collection(db, "chats"));
                    const snapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    snapshot.forEach((doc) => batch.delete(doc.ref));
                    await batch.commit();
                } catch (e) { alert("Gagal: " + e.message); }
            }
        };
    </script>
</body>
</html>
