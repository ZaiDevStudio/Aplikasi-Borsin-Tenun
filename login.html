<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - Borsin Tenun</title>
    <link rel="stylesheet" href="style.css?v=999">
    <link rel="manifest" href="manifest.json">
</head>
<body id="page-login">

    <div class="login-card">
        <img src="borsin.png" alt="Logo" class="login-logo">
        
        <div id="box-login">
            <h2 class="login-title">Selamat Datang</h2>
            <p class="login-subtitle">Masuk ke aplikasi</p>
            
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="email" placeholder="email@contoh.com" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Kata Sandi</label>
                    <input type="password" id="password" placeholder="******" required class="form-control">
                </div>
                <button type="submit" class="btn-login" id="btnLogin">MASUK</button>
            </form>

            <p>
                Belum punya akun? <br>
                <a class="text-link" id="goDaftar">Buat Akun Baru</a>
            </p>
        </div>

        <div id="box-daftar" class="hidden">
            <h2 class="login-title">Daftar</h2>
            <p class="login-subtitle">Buat akun karyawan baru</p>
            
            <form id="daftarForm">
                <div class="form-group">
                    <label>Nama Lengkap</label>
                    <input type="text" id="reg_nama" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg_email" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Sandi (Min 6)</label>
                    <input type="password" id="reg_password" required class="form-control">
                </div>
                <button type="submit" class="btn-outline">DAFTAR</button>
            </form>

            <p>
                Sudah punya akun? <br>
                <a class="text-link" id="goLogin">Kembali Login</a>
            </p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // 1. CONFIG FIREBASE (Langsung disini biar aman)
        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 2. CEK STATUS LOGIN
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Jika user sudah login, langsung lempar ke Dashboard
                window.location.href = 'dashboard.html';
            }
        });

        // 3. LOGIKA TOMBOL LOGIN
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btnLogin');
            
            btn.innerText = "Memuat...";
            btn.disabled = true;

            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    // Berhasil login, onAuthStateChanged akan otomatis redirect
                    console.log("Login Berhasil");
                })
                .catch((error) => {
                    alert("Gagal Masuk: " + error.message);
                    btn.innerText = "MASUK";
                    btn.disabled = false;
                });
        });

        // 4. LOGIKA TOMBOL DAFTAR
        document.getElementById('daftarForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const nama = document.getElementById('reg_nama').value;
            const email = document.getElementById('reg_email').value;
            const pass = document.getElementById('reg_password').value;

            if(pass.length < 6) {
                alert("Password minimal 6 karakter");
                return;
            }

            createUserWithEmailAndPassword(auth, email, pass)
                .then(async (cred) => {
                    // Simpan data user
                    await setDoc(doc(db, "users", cred.user.uid), {
                        nama: nama,
                        email: email,
                        role: 'user',
                        createdAt: new Date()
                    });
                    alert("Pendaftaran Berhasil! Mengalihkan...");
                })
                .catch((error) => {
                    alert("Gagal Daftar: " + error.message);
                });
        });

        // 5. NAVIGASI GANTI FORM
        document.getElementById('goDaftar').onclick = () => {
            document.getElementById('box-login').classList.add('hidden');
            document.getElementById('box-daftar').classList.remove('hidden');
        };
        document.getElementById('goLogin').onclick = () => {
            document.getElementById('box-login').classList.remove('hidden');
            document.getElementById('box-daftar').classList.add('hidden');
        };
    </script>
</body>
</html>
