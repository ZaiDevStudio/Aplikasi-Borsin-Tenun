<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - Borsin Tenun</title>
    <link rel="stylesheet" href="style.css?v=9999">
    <link rel="manifest" href="manifest.json">
</head>
<body id="page-login">

    <div class="login-card">
        <img src="borsin.png" alt="Logo" class="login-logo">
        
        <div id="box-login">
            <h2 class="login-title">Masuk</h2>
            <form id="loginForm">
                <div class="form-group"><label>Email</label><input type="email" id="email" required class="form-control"></div>
                <div class="form-group"><label>Sandi</label><input type="password" id="password" required class="form-control"></div>
                <button type="submit" class="btn-login" id="btnLogin">MASUK</button>
            </form>
            <p>Belum punya akun? <a class="text-link" id="goDaftar">Buat Akun Baru</a></p>
        </div>

        <div id="box-daftar" class="hidden">
            <h2 class="login-title">Daftar Baru</h2>
            <form id="daftarForm">
                <div class="form-group"><label>Nama Lengkap</label><input type="text" id="reg_nama" required class="form-control"></div>
                <div class="form-group"><label>Email</label><input type="email" id="reg_email" required class="form-control"></div>
                <div class="form-group"><label>Sandi (Min 6)</label><input type="password" id="reg_password" required class="form-control"></div>
                <button type="submit" class="btn-outline" id="btnDaftar">DAFTAR SEKARANG</button>
            </form>
            <p>Sudah punya akun? <a class="text-link" id="goLogin">Kembali Login</a></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // CONFIG FIREBASE (Langsung disini agar tidak tergantung file lain)
        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // CEK LOGIN
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Jangan redirect dulu, biar kita bisa lihat alert sukses
                console.log("User sudah login: " + user.email);
            }
        });

        // LOGIKA LOGIN
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            const btn = document.getElementById('btnLogin');
            btn.innerText = "Memuat..."; 
            
            signInWithEmailAndPassword(auth, email, pass)
                .then(() => {
                    alert("LOGIN BERHASIL! Mengalihkan ke Dashboard...");
                    window.location.href = 'dashboard.html';
                })
                .catch((error) => {
                    alert("GAGAL LOGIN: " + error.message);
                    btn.innerText = "MASUK";
                });
        });

        // LOGIKA DAFTAR (DENGAN PESAN DIAGNOSA)
        document.getElementById('daftarForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const nama = document.getElementById('reg_nama').value;
            const email = document.getElementById('reg_email').value;
            const pass = document.getElementById('reg_password').value;
            const btn = document.getElementById('btnDaftar');

            if(pass.length < 6) return alert("Password minimal 6 karakter");
            
            btn.innerText = "Mendaftar...";
            btn.disabled = true;

            // 1. Buat Akun Auth
            createUserWithEmailAndPassword(auth, email, pass)
                .then(async (cred) => {
                    alert("1. Akun Login Berhasil Dibuat! Sekarang menyimpan data ke database...");
                    
                    // 2. Simpan ke Database
                    try {
                        await setDoc(doc(db, "users", cred.user.uid), {
                            nama: nama,
                            email: email,
                            role: 'user',
                            createdAt: new Date()
                        });
                        
                        alert("2. SUKSES! Data berhasil masuk Database. Silakan cek Firebase Console sekarang.");
                        window.location.href = 'dashboard.html';
                        
                    } catch (dbError) {
                        alert("GAGAL SIMPAN DATABASE: " + dbError.message);
                        console.error(dbError);
                    }
                })
                .catch((error) => {
                    alert("GAGAL DAFTAR: " + error.message);
                    btn.innerText = "DAFTAR SEKARANG";
                    btn.disabled = false;
                });
        });

        // Navigasi
        document.getElementById('goDaftar').onclick = () => {
            document.getElementById('box-login').classList.add('hidden');
            document.getElementById('box-daftar').classList.remove('hidden');
        };
        document.getElementById('goLogin').onclick = () => {
            document.getElementById('box-login').classList.remove('hidden');
            document.getElementById('box-daftar').classList.add('hidden');
        };
    </script>
</body>
</html>
