<!DOCTYPE html><html lang="id"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Jual</title><link rel="stylesheet" href="style.css?v=FINAL"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"></head><body>
<div class="navbar"><a href="dashboard.html" class="nav-btn"><i class="fas fa-arrow-left"></i></a><div class="brand-text"><h2>Input Jual</h2><p>Stok Keluar</p></div></div><div class="container"><div class="card"><form id="f"><label>Ulos</label><select id="ulos" class="form-control"><option>-- Pilih --</option></select><p id="stok" style="color:#666;font-size:.8rem;margin:5px 0"></p><label>Jumlah</label><input type="number" id="jml" required class="form-control"><label>Tanggal</label><input type="date" id="tgl" required class="form-control"><button id="btn" class="btn">SIMPAN & KURANGI STOK</button></form></div></div><div class="bottom-nav"><a href="dashboard.html" class="nav-item"><i class="fas fa-home"></i><span>Home</span></a><a href="pesanan.html" class="nav-item"><i class="fas fa-clipboard-list"></i><span>Pesanan</span></a><a href="data_karyawan.html" class="nav-item"><i class="fas fa-users"></i><span>Karyawan</span></a><a href="slip_gaji.html" class="nav-item"><i class="fas fa-wallet"></i><span>Keuangan</span></a></div>
<script type="module">import{db}from"./config.js";import{collection,addDoc,getDocs,query,orderBy,doc,updateDoc}from"https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";let um={}; (async()=>{const u=await getDocs(query(collection(db,"ulos"),orderBy("nama")));const su=document.getElementById('ulos');su.innerHTML='<option value="">-- Pilih --</option>';u.forEach(d=>{const dt=d.data();su.innerHTML+=`<option value="${dt.nama}">${dt.nama}</option>`;um[dt.nama]={id:d.id,s:Number(dt.stock)||0,h:Number(dt.harga)||0,f:dt.foto};});document.getElementById('tgl').valueAsDate=new Date();})();document.getElementById('ulos').onchange=function(){const d=um[this.value];if(d)document.getElementById('stok').innerHTML=`Stok: <strong>${d.s}</strong>`;};document.getElementById('f').onsubmit=async e=>{e.preventDefault();const btn=document.getElementById('btn');btn.innerText="...";btn.disabled=true;try{const nm=document.getElementById('ulos').value, j=Number(document.getElementById('jml').value), t=document.getElementById('tgl').value;const info=um[nm];if(info.s<j)throw new Error("Stok Kurang!");await updateDoc(doc(db,"ulos",info.id),{stock:info.s-j});await addDoc(collection(db,"terjual"),{nama_ulos:nm,jumlah:j,tanggal_jual:t,foto:info.f,total_harga:j*info.h,timestamp:new Date()});alert("Berhasil!");window.location.href="riwayat_terjual.html";}catch(er){alert(er.message);btn.innerText="SIMPAN";btn.disabled=false}}</script></body></html>
