<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Input Jual</title>
    <link rel="stylesheet" href="style.css?v=9999">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Tambahan jarak agar tidak tertutup navigasi */
        .container { padding-bottom: 100px; }
    </style>
</head>
<body id="page-tambah-terjual">
    
    <div class="navbar">
        <a href="dashboard.html" class="nav-btn"><i class="fas fa-arrow-left"></i></a>
        <div class="brand-text">
            <h2>Input Jual</h2>
            <p>Stok Keluar</p>
        </div>
    </div>

    <div class="container">
        <div class="card">
            <div style="background:#e8f5e9; color:#1b5e20; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.85rem; border:1px solid #c8e6c9;">
                <i class="fas fa-info-circle"></i> <strong>Info:</strong> Data yang disimpan akan otomatis mengurangi stok di Galeri Ulos.
            </div>

            <form id="formJual">
                <div class="form-group">
                    <label>Pilih Ulos Terjual</label>
                    <select id="nama_ulos" class="form-control" required>
                        <option value="">-- Sedang mengambil data... --</option>
                    </select>
                    
                    <img id="preview_foto" src="" style="display:none; width: 100%; max-width: 150px; margin-top: 10px; border-radius: 10px; border: 1px solid #ccc; padding:2px;">
                    
                    <p id="info_stok" style="margin-top:5px; font-size:0.9rem; color:#666;"></p>
                </div>

                <div class="form-group">
                    <label>Jumlah Terjual (Lembar)</label>
                    <input type="number" id="jumlah" required class="form-control" placeholder="0">
                </div>

                <div class="form-group">
                    <label>Tanggal Penjualan</label>
                    <input type="date" id="tanggal_jual" class="form-control">
                </div>

                <button type="submit" id="btnSimpan" class="btn btn-success" style="margin-top:15px;">Simpan & Kurangi Stok</button>
            </form>
        </div>
    </div>

    <div class="bottom-nav" style="position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: #ffffff; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 99999; box-shadow: 0 -4px 10px rgba(0,0,0,0.1);">
        <a href="dashboard.html" class="nav-item"><i class="fas fa-home" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Home</span></a>
        <a href="pesanan.html" class="nav-item"><i class="fas fa-clipboard-list" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Pesanan</span></a>
        <a href="data_karyawan.html" class="nav-item"><i class="fas fa-users" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Karyawan</span></a>
        <a href="slip_gaji.html" class="nav-item"><i class="fas fa-wallet" style="font-size:1.4rem;margin-bottom:4px;"></i><span>Keuangan</span></a>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, doc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAXM4yJgh9F7ajGQApB-Ux1itQ_3pkik_o",
            authDomain: "borsin-tenun-app.firebaseapp.com",
            projectId: "borsin-tenun-app",
            storageBucket: "borsin-tenun-app.firebasestorage.app",
            messagingSenderId: "718889934564",
            appId: "1:718889934564:web:c28a073e261d6783d096f1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let ulosDataMap = {}; 

        // 1. LOAD DATA ULOS
        async function loadData() {
            const select = document.getElementById('nama_ulos');
            try {
                const q = query(collection(db, "ulos"), orderBy("nama"));
                const snap = await getDocs(q);
                
                select.innerHTML = '<option value="">-- Pilih Ulos --</option>';
                
                if (snap.empty) {
                    alert("Data Ulos Kosong! Input data ulos dulu.");
                    return;
                }

                snap.forEach(doc => {
                    const d = doc.data();
                    const opt = document.createElement('option');
                    opt.value = d.nama;
                    opt.text = d.nama;
                    select.appendChild(opt);

                    ulosDataMap[d.nama] = {
                        id: doc.id,
                        foto: d.foto,
                        stock: Number(d.stock) || 0,
                        harga: Number(d.harga) || 0
                    };
                });

            } catch (error) {
                alert("Gagal memuat data: " + error.message);
                select.innerHTML = '<option value="">-- Gagal Memuat --</option>';
            }
        }

        // 2. EVENT PILIH ULOS
        document.getElementById('nama_ulos').addEventListener('change', function() {
            const nama = this.value;
            const data = ulosDataMap[nama];
            const img = document.getElementById('preview_foto');
            const info = document.getElementById('info_stok');

            if (data) {
                if (data.foto) { img.src = data.foto; img.style.display = 'block'; } 
                else { img.style.display = 'none'; }
                
                info.innerHTML = `Sisa Stok: <strong>${data.stock} Lembar</strong>`;
                if (data.stock <= 0) info.innerHTML += ' <span style="color:red; font-weight:bold;">(HABIS!)</span>';
            } else {
                img.style.display = 'none';
                info.innerHTML = '';
            }
        });

        // 3. SIMPAN
        document.getElementById('formJual').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSimpan');
            btn.innerText = "Memproses..."; btn.disabled = true;

            try {
                const namaUlos = document.getElementById('nama_ulos').value;
                const jumlahJual = Number(document.getElementById('jumlah').value);
                const tgl = document.getElementById('tanggal_jual').value || new Date().toISOString().split('T')[0];
                
                const ulosInfo = ulosDataMap[namaUlos];

                if (!ulosInfo) throw new Error("Silakan pilih Ulos terlebih dahulu!");
                if (jumlahJual <= 0) throw new Error("Jumlah minimal 1");
                if (ulosInfo.stock < jumlahJual) throw new Error(`Stok tidak cukup! Sisa: ${ulosInfo.stock}`);

                // Kurangi Stok
                const sisaStok = ulosInfo.stock - jumlahJual;
                await updateDoc(doc(db, "ulos", ulosInfo.id), { stock: sisaStok });

                // Simpan Riwayat
                await addDoc(collection(db, "terjual"), {
                    nama_ulos: namaUlos,
                    jumlah: jumlahJual,
                    tanggal_jual: tgl,
                    foto: ulosInfo.foto,
                    total_harga: jumlahJual * ulosInfo.harga,
                    timestamp: new Date()
                });

                alert("BERHASIL! Data disimpan & Stok berkurang.");
                window.location.href = "riwayat_terjual.html";

            } catch (error) {
                alert("Gagal: " + error.message);
                btn.innerText = "Simpan & Kurangi Stok"; btn.disabled = false;
            }
        });

        document.getElementById('tanggal_jual').valueAsDate = new Date();
        loadData();
    </script>
</body>
</html>
